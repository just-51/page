<script>
  const video = document.getElementById('video');
  const buttons = document.querySelectorAll('.video-button');
  const loadingOverlay = document.getElementById('loadingOverlay');
  let hls = null;
  let saveInterval = null;

  function isIOS() {
    return /iP(hone|od|ad)/.test(navigator.userAgent);
  }

  function saveProgress(url, time) {
    localStorage.setItem("progress_" + url, time.toFixed(1));
    localStorage.setItem("last_video_url", url);   // ✅ 记录最后播放的视频
  }

  function loadProgress(url) {
    const t = parseFloat(localStorage.getItem("progress_" + url));
    return isNaN(t) ? 0 : t;
  }

  function setActiveButton(enc) {
    buttons.forEach(btn => {
      btn.classList.toggle('active', btn.dataset.enc.trim() === enc);
    });
  }

  function showLoading() {
    loadingOverlay.style.display = 'flex';
  }

  function hideLoading() {
    loadingOverlay.style.display = 'none';
  }

  function decodeBase64(str) {
    try {
      return atob(str);
    } catch (e) {
      alert("视频地址解码失败");
      return "";
    }
  }

  function actuallyLoadSource(url, resumeTime, isM3U8) {
    showLoading();
    const fullUrl = url + "?t=" + Math.random();

    if (isM3U8 && !isIOS() && typeof Hls !== 'undefined') {
      hls = new Hls();
      hls.loadSource(fullUrl);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED, () => {
        video.currentTime = resumeTime;
        video.play().catch(() => {});
      });
    } else {
      video.src = fullUrl;
      video.addEventListener('loadedmetadata', function onLoaded() {
        video.removeEventListener('loadedmetadata', onLoaded);
        video.currentTime = resumeTime;
        video.play().catch(() => {});
      });
    }

    video.addEventListener('loadedmetadata', () => {
      video.controls = true;
    });

    clearInterval(saveInterval);
    saveInterval = setInterval(() => {
      if (!video.paused && !video.ended) {
        saveProgress(url, video.currentTime);
      }
    }, 3000);
  }

  function loadVideoFromEncoded(encStr) {
    const url = decodeBase64(encStr.trim());
    if (!url) return;

    const isM3U8 = url.includes(".m3u8");
    const resumeTime = loadProgress(url);

    showLoading();

    video.pause();
    video.removeAttribute('src');
    video.removeAttribute('poster');
    video.load();
    video.currentTime = 0;
    video.controls = false;

    if (hls) {
      hls.destroy();
      hls = null;
    }

    setActiveButton(encStr);

    setTimeout(() => {
      actuallyLoadSource(url, resumeTime, isM3U8);
    }, 100);
  }

  video.addEventListener('playing', hideLoading);
  video.addEventListener('canplay', hideLoading);

  // ✅ 页面加载时检查是否有上次观看的视频和进度
  const lastUrl = localStorage.getItem("last_video_url");
  if (lastUrl) {
    // 找到和 lastUrl 匹配的按钮
    let foundBtn = null;
    buttons.forEach(btn => {
      if (decodeBase64(btn.dataset.enc.trim()) === lastUrl) {
        foundBtn = btn;
      }
    });
    if (foundBtn) {
      loadVideoFromEncoded(foundBtn.dataset.enc.trim());
    } else {
      // 没找到就默认加载第一个
      loadVideoFromEncoded(buttons[0].dataset.enc.trim());
    }
  } else {
    // 第一次访问，默认加载第一个视频
    loadVideoFromEncoded(buttons[0].dataset.enc.trim());
  }

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      loadVideoFromEncoded(btn.dataset.enc.trim());
    });
  });
</script>
